---
title: "04b_fig3"
author: "Yongxuan Guo"
date: "2022/6/4"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# fig3. Global WUI change percentage from 2000 to 2020, zoom in area shows how WUI change in detail.
## set work directory and load packages
```{r}
library(raster)
library(sf)
library(foreach)
library(doParallel)
library(sp)
library(rasterVis)
library(RColorBrewer)
library(dplyr)
library(scales)
library(aplot)
library(ggplot2)
library(cowplot)
library(ggnewscale)
library(spData)
library(rgeoda)
library(ggsci)
library(patchwork)
library(ggmap)
library(ggrepel)
library(ggpubr)
raster::rasterOptions(tmpdir = '/project/public/')

idir <- "~/wildfire/WUI/data/01_GlobeLand30/"
wgs84 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
```

## how WUI changed
```{r}
# read 1km WUI
wd <- paste0(idir, '1km/')
files <- dir(path = wd, pattern = glob2rx('*rmNA*.tif'))
rList <- NULL
WUI_area <- NULL
for(i in 1:length(files)){
  rList[[i]] <- raster(paste0(wd, files[i]))
}
# 2020-2020
delta <- rList[[3]] - rList[[1]]
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
writeRaster(delta, filename = paste0(odir, "delta_20-00.tif"), overwrite = T)
```

## draw global change between 2000 and 2020 (0.1°)
### prepare change data
```{r}
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
delta <- raster(paste0(odir, "delta_20-00.tif"))
                
# 0.5°version 
# delta <- aggregate(delta, fact = c(50, 50)) 
# delta[delta == 0] <- NA
# df <- as.data.frame(delta, xy=T)
# names(df) <- c('x', 'y', 'delta')
# d <- filter(df, !is.na(delta))
# natural_breaks(12, d["delta"])
# my_at <- c(-1, -0.01, -0.005, -0.003, 0.003, 0.005, 0.01, 0.03, 0.05, 0.09, 1)
# df$valueDiscr <- cut(df$delta,
#                      breaks = my_at, right = T)

# 0.1°version
delta <- aggregate(delta, fact = c(10, 10))
delta[delta == 0] <- NA
df <- as.data.frame(delta, xy=T)
names(df) <- c('x', 'y', 'delta')
# d <- filter(df, !is.na(delta))
# natural_breaks(12, d["delta"])
my_at <- c(-1, -0.05, -0.03, -0.01, -0.005, 0.005, 0.01, 0.03, 0.05, 0.1, 0.3, 1)
df$valueDiscr <- cut(df$delta,
                     breaks = my_at, right = T)
```

### ocean bottom data
```{r}
# read original data
wd <- "~/wildfire/WUI/data/00_spatial/Blue-Earth-Bathymetry/"
bath <- raster(paste0(wd, "Blue-Earth-Bathymetry.tif"))

# crop and resample data to align main result
bath2 <- crop(bath, delta)
bath3 <- resample(bath2, delta)

# remove terrestrial data
bath3[bath3 > 0] <- NA

# get dataframe
df_b <- as.data.frame(bath3, xy = T)
```

### draw
```{r}
# zoomin area annotation
# points <-cbind(x = c(-122.75,113.75,-45.75,146.25,86.25), y = c(38.25,22.75,-21.25,-35.75,52.25)) %>%
#   as.data.frame()
points <-cbind(x = c(-82, 27.5, 114), y = c(36, -26, 22.75)) %>%
  as.data.frame()
# points <-cbind(x = c(-82, -48, 27.5, 29, 114, 148), y = c(36, -24, -26, 57, 22.75, -35)) %>%
  # as.data.frame()
# purple-orange
# cols1 <- rev(c(rev(c('#fef0d9','#fdd49e','#fdbb84','#fc8d59','#e34a33','#b30000')),'transparent','#cbc9e2','#9e9ac8','#6a51a3'))
# green-pink-purple
cols1 <- rev(c(rev(c('#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177')),'transparent','#a1d99b','#74c476','#31a354','#006d2c'))

world <- filter(spData::world, region_un!="Antarctica")
world <- st_transform(world, crs = crs(delta))
# 0.5°version
# p <- ggplot() +
#   geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
#   scale_fill_gradient(low = "#21ADE3", high = "#f7fbff", na.value = "transparent", guide = 'none', limits = c(-12000,0)) +  
#   geom_sf(data = world, fill = '#252525', color = NA) +
#   
#   new_scale_fill() +
#   geom_raster(data = df, aes(x = x, y = y,fill = valueDiscr)) +
#   
#   theme_classic() +
#   scale_fill_manual(values = cols1, na.translate = F, 
#                     labels = c('    ', '  -1', '-0.5','-0.3', ' 0.3', ' 0.5', '   1', '   3', '   5', '   9', '    '),                    
#                     guide = guide_legend(nrow = 1, 
#                                          label.position = "bottom", title.position = "top",
#                                          title = expression(Delta(WUI)~'(%)'),
#                                          title.hjust = 0.5,
#                                          label.hjust = -4)) +
#   scale_x_continuous(expand=c(0,0)) +
#   scale_y_continuous(expand=c(0,0)) +
#   geom_sf(data = world, fill = NA, linewidth = 0.05, color = "#969696", alpha = 0.5) +
#   geom_point(data = points, aes(x=x,y=y), color = 'black', fill = '#addd8e', stroke = 0.5, shape = 21, size = 2) +
#   # borders(colour = "black", size = 0.3, fill = rgb(0.5,0.5,0.5, 0.15), xlim = c(-180, 180), ylim = c(-61, 90)) +
#   # coord_quickmap(expand = FALSE, xlim = c(-180, 180), ylim = c(-61, 90)) +
#   theme(legend.position = c(0.15,0.12),
#         legend.direction = 'horizontal',
#         legend.key.size = unit(0.5, 'cm'),
#         legend.spacing.x = unit(0, 'cm'),
#         legend.background = element_blank(), 
#         legend.title = element_text(size = 18),
#         panel.border = element_blank(),
#         legend.margin=margin(0,0,0,0),
#         legend.box.margin=margin(0,0,0,0),
#         legend.text = element_text(color = "black", size = 15),
#         axis.text.x  = element_blank(),
#         axis.text.y  = element_blank(),
#         axis.line = element_blank(),
#         axis.ticks = element_blank(),
#         plot.title = element_text(hjust = 0.1, vjust = -5), 
#         plot.margin= grid::unit(c(0, 0.2, 0.5, 0), "in")) +
#   labs(x ="", y = "") 

# 0.1°version
p <- ggplot() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_gradient(low = "#21ADE3", high = "#f7fbff", na.value = "transparent", guide = 'none', limits = c(-12000,0)) +
  geom_sf(data = world, fill = '#252525', color = NA) +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  new_scale_fill() +
  geom_raster(data = df, aes(x = x, y = y,fill = valueDiscr)) +
  theme_classic() +
  scale_fill_manual(values = cols1, na.translate = F, 
                    labels = c('    ', '  -5', '  -3','  -1', '-0.5', ' 0.5', '   1', '   3', '   5', '  10', '   30', ''),                 
                    guide = guide_legend(nrow = 1, 
                                         keywidth = 0.6, keyheight = 0.8,
                                         label.position = "bottom", title.position = "top",
                                         title = expression(Delta(WUI)~'(%)'),
                                         title.hjust = 0.5,
                                         label.hjust = -4)) +
  geom_sf(data = world, fill = NA, linewidth = 0.05, color = "#969696", alpha = 0.5) +
  geom_point(data = points, aes(x=x,y=y), color = 'black', fill = '#addd8e', stroke = 0.5, shape = 21, size = 1) +
  # borders(colour = "black", size = 0.3, fill = rgb(0.5,0.5,0.5, 0.15), xlim = c(-180, 180), ylim = c(-61, 90)) +
  # coord_quickmap(expand = FALSE, xlim = c(-180, 180), ylim = c(-61, 90)) +
  theme(legend.position = c(0.6,0.12),
        legend.direction = 'horizontal',
        # legend.key.size = unit(0.3, 'cm'),
        legend.spacing.x = unit(0, 'cm'),
        legend.background = element_blank(), 
        legend.title = element_text(size = 10),
        panel.border = element_blank(),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(0,0,0,0),
        legend.text = element_text(color = "black", size = 10),
        axis.text.x  = element_blank(),
        axis.text.y  = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust = 0.1, vjust = -5), 
        plot.margin= grid::unit(c(0, 0.2, 0.5, 0), "in")) +
  labs(x ="", y = "") 

odir <- "~/wildfire/WUI/data/02_analysis/0401"
ggsave(plot = p,
       filename = "fig3_20-00_0.1.pdf",
       device = "pdf", path = odir,
       width = 7, height = 5, units = "in",
       dpi = 320)

```

### draw local change
```{r}
adm.dir <- "/sdd/gadm/boundary/"
# load the boundaries -----------------------------------------------------
adm2 <- rgdal::readOGR(paste0(adm.dir, "adm2.shp"))

# raster path
idir <- "/project/public/temp_yx/"
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
files_W <- dir(path = paste0(idir, "2000LC/rmNA"), pattern = glob2rx('*WUI*.tif'))
files_O <- dir(path = paste0(idir, "2000LC/origin"), pattern = glob2rx('*.tif'))

# set color
LCcodes <- c(1:7, 10)
LCnames <-c("2000", "2010", "2020", "00_10", "00_20", "10_20", "001020","Wildland")
LCcolors <- c(rgb(101,212,240,maxColorValue = 255),
              rgb(255,236,161,maxColorValue = 255),
              rgb(255,135,143,maxColorValue = 255),
              rgb(82,171,82,maxColorValue = 255),
              rgb(220,128,255,maxColorValue = 255),
              rgb(255,190,99,maxColorValue = 255),
              rgb(255,244,38,maxColorValue = 255),
              "#cae2bc")
names(LCcolors) <- as.character(LCcodes)

# east America extent(-82.5, -82, 36, 36.5)
i <- 130
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -81.5 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -81.5 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -81.5 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -81.5 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(-82.5, -81.5, 36, 36.5)) %>%
  sf::st_as_sf()

p1 <- ggplot() +
    geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
    scale_fill_manual(name = "",
                      values = LCcolors,
                      labels = LCnames,
                      na.translate = FALSE,
                      guide = 'none') +
    
    geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
    theme_bw() +
    theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(2,2,2,2),
        legend.background = element_rect(color = "transparent", fill ="transparent"),
        axis.text = element_text(size = 12)) +
    scale_x_continuous(expand = c(0,0), breaks = c(-82.5, -82, -81.5), limits = c(-82.5, -81.5)) +
    scale_y_continuous(expand = c(0,0), breaks = c(36.1, 36.4), limits = c(36, 36.5)) +
    labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = -82.5, xmax = -81.5, ymin = 36, ymax = 36.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
    guides(fill = "none")

# South Africa extent(27.5, 28, -26, -25.5)
i <- 726
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(27, 28, -26, -25.5)) %>%
  sf::st_as_sf()

p3 <- ggplot() +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(27, 27.5, 28), limits = c(27,28)) +
  scale_y_continuous(expand = c(0,0), breaks = c(-25.9, -25.6), limits = c(-26, -25.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 27, xmax = 28, ymin = -26, ymax = -25.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")

# Pearl river delta extent(114,114.5,22.5,23)
i <- 500
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 115 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 115 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 115 23 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 115 23 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(114,115,22.5,23)) %>%
  sf::st_as_sf()

p5 <- ggplot() +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,4,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(114, 114.5, 115), limits = c(114, 115)) +
  scale_y_continuous(expand = c(0,0), breaks = c(22.6, 22.9), limits = c(22.5, 23)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 114, xmax = 115, ymin = 22.5, ymax = 23), color = "black", inherit.aes = FALSE, fill = "transparent")

odir <- "~/wildfire/WUI/data/02_analysis/1109/"
ggsave(plot = p1,
       filename = "fig3_local_EUS.pdf",
       device = "pdf", path = odir,
       width = 6, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p3,
       filename = "fig3_local_SAfrica.pdf",
       device = "pdf", path = odir,
       width = 6, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p5,
       filename = "fig3_local_CA.pdf",
       device = "pdf", path = odir,
       width = 8, height = 3, units = "in",
       dpi = 320)
```

### draw local change (ggmap basemap)
```{r}
# raster path
idir <- "/project/public/temp_yx/"
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
files_W <- dir(path = paste0(idir, "2000LC/rmNA"), pattern = glob2rx('*WUI*.tif'))
files_O <- dir(path = paste0(idir, "2000LC/origin"), pattern = glob2rx('*.tif'))

# set color
LCcodes <- c(1:7, 10)
LCnames <-c("2000", "2010", "2020", "00_10", "00_20", "10_20", "001020","Wildland")
LCcolors <- c(rgb(101,212,240,maxColorValue = 255),
              rgb(255,236,161,maxColorValue = 255),
              rgb(255,135,143,maxColorValue = 255),
              rgb(82,171,82,maxColorValue = 255),
              rgb(220,128,255,maxColorValue = 255),
              rgb(255,190,99,maxColorValue = 255),
              rgb(255,244,38,maxColorValue = 255),
              "transparent")
names(LCcolors) <- as.character(LCcodes)

# east America extent(-82.5, -82.3, 36, 36.5)
i <- 130
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
dc <- crop(d, extent(-82.5, -82.3, 36.3, 36.4))
df_d <- as.data.frame(dc, xy = T)
names(df_d) <- c("x", "y", "LC")

myLocation <- c(-82.5, 36.3, -82.3, 36.4)
myMap <- get_map(location = myLocation,
                 source = "stamen", maptype = "terrain-background", crop = FALSE)
city <- cbind(36.315234726641776, -82.35369304325661, 'Johnson City') %>%
  as.data.frame()
names(city) <- c('y', 'x', 'name')
city$x <- as.double(city$x)
city$y <- as.double(city$y)

p1 <- ggmap(myMap) +
    geom_point(data = df_d, aes(x = x, y = y, color = as.character(LC)), size = 0.5) +
    geom_point(data = city, mapping = aes(x = x, y = y), color = 'black', fill = 'red', shape = 21, size = 1, stroke = 0.5) + 
    geom_text_repel(data = city, mapping = aes(x = x, y = y, label = name), color = 'white', size = 3, bg.color = "black", nudge_y = 0.007, nudge_x = 0.001) +
    scale_color_manual(name = "",
                       values = LCcolors,
                       labels = LCnames,
                       na.translate = FALSE,
                       guide = 'none') +
    theme_bw() +
    theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(2,2,2,2),
        legend.background = element_rect(color = "transparent", fill ="transparent"),
        axis.text = element_text(size = 6), 
        axis.text.y = element_text(angle = 90, hjust = 0.5)) +
    scale_x_continuous(expand = c(0,0), breaks = c(-82.45, -82.35), label = c('82.45°W', '82.35°W'), limits = c(-82.5, -82.4)) +
    scale_y_continuous(expand = c(0,0), breaks = c(36.32, 36.37), label = c('36.32°N', '36.37°N'), limits = c(36.3, 36.4)) +
    labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = -82.5, xmax = -82.3, ymin = 36.3, ymax = 36.4), color = "black", inherit.aes = FALSE, fill = "transparent") + 
    guides(fill = "none")


# South Africa extent(27.2, 27.4, -25.7, -25.6)
i <- 726
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
dc <- crop(d, extent(27.2, 27.4, -25.7, -25.6))
df_d <- as.data.frame(dc, xy = T)
names(df_d) <- c("x", "y", "LC")

myLocation <- c(27, -26, 27.4, -25.5)
myMap <- get_map(location = myLocation,
                 source = "stamen", maptype = "terrain", crop = FALSE)
city <- cbind(-25.6532131428673, 27.25591543700737, 'Rustenburg') %>%
  as.data.frame()
names(city) <- c('y', 'x', 'name')
city$x <- as.double(city$x)
city$y <- as.double(city$y)

p2 <- ggmap(myMap) +
  geom_point(data = df_d, aes(x = x, y = y, color = as.character(LC)), size = 0.5) +
  geom_point(data = city, mapping = aes(x = x, y = y), color = 'black', fill = 'red', shape = 21, size = 1, stroke = 0.5) + 
  geom_text_repel(data = city, mapping = aes(x = x, y = y, label = name), color = 'white', size = 3, bg.color = "black", nudge_y = 0.007, nudge_x = 0.001) +
  scale_color_manual(name = "",
                     values = LCcolors,
                     labels = LCnames,
                     na.translate = FALSE,
                     guide = 'none') +
  theme_bw() +
  theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(2,2,2,2),
        legend.background = element_rect(color = "transparent", fill ="transparent"),
        axis.text = element_text(size = 6), 
        axis.text.y = element_text(angle = 90, hjust = 0.5)) +
  scale_x_continuous(expand = c(0,0), breaks = c(27.25, 27.35), label = c('27.25°E', '27.35°E'), limits = c(27.3, 27.4)) +
  scale_y_continuous(expand = c(0,0), breaks = c(-25.68, -25.63), label = c('25.68°S', '25.63°S'), limits = c(-25.7, -25.6)) +
  labs(x ="", y = "", fill = '') +
  guides(fill = "none")

# Pearl river delta extent(114.4,114.6,22.55,22.65)
i <- 500
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
dc <- crop(d, extent(114.4,114.6,22.55,22.65))
df_d <- as.data.frame(dc, xy = T)
names(df_d) <- c("x", "y", "LC")

myLocation <- c(114.4, 22.55, 114.6, 22.65)
myMap <- get_map(location = myLocation,
                 source = "stamen", maptype = "terrain-background", crop = FALSE)
city <- cbind(22.599007134034593, 114.53970578303922, 'Dakeng') %>%
  as.data.frame()
names(city) <- c('y', 'x', 'name')
city$x <- as.double(city$x)
city$y <- as.double(city$y)

p3 <- ggmap(myMap) +
    geom_point(data = df_d, aes(x = x, y = y, color = as.character(LC)), size = 0.5) +
  geom_point(data = city, mapping = aes(x = x, y = y), color = 'black', fill = 'red', shape = 21, size = 1, stroke = 0.5) + 
  geom_text_repel(data = city, mapping = aes(x = x, y = y, label = name), color = 'white', size = 3, bg.color = "black", nudge_y = 0.007, nudge_x = 0.001) +
    scale_color_manual(name = "",
                       values = LCcolors,
                       labels = LCnames,
                       na.translate = FALSE,
                       guide = 'none') +
    theme_bw() +
    theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(2,2,2,2),
        legend.background = element_rect(color = "transparent", fill ="transparent"),
        axis.text = element_text(size = 6), 
        axis.text.y = element_text(angle = 90, hjust = 0.5)) +
    scale_x_continuous(expand = c(0,0), breaks = c(114.45, 114.55), label = c('114.45°E', '114.55°E'), limits = c(114.4, 114.5)) +
    scale_y_continuous(expand = c(0,0), breaks = c(22.62, 22.57), label = c('22.62°N', '22.57°N'), limits = c(22.55, 22.65)) +
    labs(x ="", y = "", fill = '') + 
    guides(fill = "none")

odir <- "~/wildfire/WUI/data/02_analysis/0401/"
ggsave(plot = p1,
       filename = "fig3_local_EUS.pdf",
       device = "pdf", path = odir,
       width = 70, height = 50, units = "mm",
       dpi = 320)
ggsave(plot = p2,
       filename = "fig3_local_SAfrica.pdf",
       device = "pdf", path = odir,
       width = 70, height = 50, units = "mm",
       dpi = 320)
ggsave(plot = p3,
       filename = "fig3_local_CA.pdf",
       device = "pdf", path = odir,
       width = 70, height = 50, units = "mm",
       dpi = 320)
```

### draw local change (WGS84, with adm2 boundary)
```{r}
adm.dir <- "/sdd/gadm/boundary/"
# load the boundaries -----------------------------------------------------
adm2 <- rgdal::readOGR(paste0(adm.dir, "adm2.shp"))

# raster path
idir <- "/project/public/temp_yx/"
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
wgs84 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
files_W <- dir(path = paste0(idir, "2000LC/rmNA"), pattern = glob2rx('*WUI*.tif'))
files_O <- dir(path = paste0(idir, "2000LC/origin"), pattern = glob2rx('*.tif'))

# set color
LCcodes <- c(1:7, 10)
LCnames <-c("2000", "2010", "2020", "00_10", "00_20", "10_20", "001020","Wildland")
LCcolors <- c(rgb(101,212,240,maxColorValue = 255),
              rgb(255,236,161,maxColorValue = 255),
              rgb(255,135,143,maxColorValue = 255),
              rgb(82,171,82,maxColorValue = 255),
              rgb(220,128,255,maxColorValue = 255),
              rgb(255,190,99,maxColorValue = 255),
              rgb(255,244,38,maxColorValue = 255),
              "#cae2bc")
names(LCcolors) <- as.character(LCcodes)

# east America extent(-82.5, -82, 36, 36.5)
i <- 130
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -82 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -82 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -82 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -82.5 36 -82 36.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(-82.5, -82, 36, 36.5)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p1 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(2,2,2,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(-82.5, -82), limits = c(-82.5, -82)) +
  scale_y_continuous(expand = c(0,0), breaks = c(36, 36.5), limits = c(36, 36.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = -82.5, xmax = -82, ymin = 36, ymax = 36.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")

# South America extent(-48, -47.5, -24, -23.5)
i <- 686
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -48 -24 -47.5 -23.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -48 -24 -47.5 -23.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -48 -24 -47.5 -23.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -48 -24 -47.5 -23.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(-48, -47.5, -24, -23.5)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p2 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(-48, -47.5), limits = c(-48, -47.5)) +
  scale_y_continuous(expand = c(0,0), breaks = c(-24, -23.5), limits = c(-24, -23.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = -48, xmax = -47.5, ymin = -24, ymax = -23.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")

# South Africa extent(27.5, 28, -26, -25.5)
i <- 726
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27.5 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27.5 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27.5 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 27.5 -26 28 -25.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(27.5, 28, -26, -25.5)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p3 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', lwd = 0.2, color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(27.5, 28), limits = c(27.5,28)) +
  scale_y_continuous(expand = c(0,0), breaks = c(-26, -25.5), limits = c(-26, -25.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 27.5, xmax = 28, ymin = -26, ymax = -25.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")

# Mid Europe extent(29, 29.5, 57, 57.5)
i <- 311
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 29 57 29.5 57.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 29 57 29.5 57.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 29 57 29.5 57.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 29 57 29.5 57.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(29, 29.5, 57, 57.5)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p4 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(29, 29.5), limits = c(29, 29.5)) +
  scale_y_continuous(expand = c(0,0), breaks = c(57, 57.5), limits = c(57, 57.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 29, xmax = 29.5, ymin = 57, ymax = 57.5), color = "black", inherit.aes = FALSE, fill = "transparent")

# Pearl river delta extent(114,114.5,22.5,23)
i <- 500
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 114.5 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 114.5 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 114.5 23 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 114 22.5 114.5 23 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(114,114.5,22.5,23)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p5 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(114, 114.5), limits = c(114, 114.5)) +
  scale_y_continuous(expand = c(0,0), breaks = c(22.5, 23), limits = c(22.5, 23)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 114, xmax = 114.5, ymin = 22.5, ymax = 23), color = "black", inherit.aes = FALSE, fill = "transparent")
  
# Southeast Australia extent(148, 148.5, -35, -34.5)
i <- 814
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 148 -35 148.5 -34.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 148 -35 148.5 -34.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 148 -35 148.5 -34.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 148 -35 148.5 -34.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
d <- c
d[c==0] <- NA
d[c==-10] <- 10
d[c==1|c==-9] <- 1
d[c==2|c==-8] <- 2
d[c==4|c==-6] <- 3
d[c==3|c==-7] <- 4
d[c==5|c==-5] <- 5
d[c==6|c==-4] <- 6
d[c==7|c==-3] <- 7
df_d <- as.data.frame(d, xy = T)
names(df_d) <- c("x", "y", "LC")

a <- crop(adm2, extent(148, 148.5, -35, -34.5)) %>%
  sf::st_as_sf()
bath2 <- crop(bath, c)
bath3 <- resample(bath, c)
bath3[bath3 > 0] <- NA
df_b <- as.data.frame(bath3, xy = T)

p6 <- ggplot() +
  geom_sf(data = a, fill = '#252525') +
  geom_raster(data = df_d, aes(x = x, y = y, fill = as.character(LC))) +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE,
                    guide = 'none') +
  new_scale_fill() +
  geom_raster(data = df_b, mapping = aes(x = x, y = y, fill = Blue.Earth.Bathymetry)) +
  scale_fill_distiller(na.value = 'transparent', guide = 'none') +
  geom_sf(data = a, fill = 'NA', color = "#bdbdbd") +
  theme_bw() +
  theme(
    plot.background = element_rect(color = "transparent", fill ="transparent"),
    plot.margin = margin(6,2,1,2),
    legend.background = element_rect(color = "transparent", fill ="transparent"),
    axis.text = element_text(size = 12)) +
  scale_x_continuous(expand = c(0,0), breaks = c(148, 148.5), limits = c(148, 148.5)) +
  scale_y_continuous(expand = c(0,0), breaks = c(-35, -34.5), limits = c(-35, -34.5)) +
  labs(x ="", y = "", fill = '') +
  geom_rect(aes(xmin = 148, xmax = 148.5, ymin = -35, ymax = -34.5), color = "black", inherit.aes = FALSE, fill = "transparent")

odir <- "~/wildfire/WUI/data/02_analysis/1007/"
ggsave(plot = p1,
       filename = "fig3_local_EUS.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p2,
       filename = "fig3_local_SAmerica.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p3,
       filename = "fig3_local_SAfrica.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p4,
       filename = "fig3_local_ME.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",)
ggsave(plot = p5,
       filename = "fig3_local_CA.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",
       dpi = 320)
ggsave(plot = p6,
       filename = "fig3_local_SEA.pdf",
       device = "pdf", path = odir,
       width = 4, height = 3, units = "in",
       dpi = 320)
```


### draw local change (discard)
```{r}
adm.dir <- "/sdd/gadm/boundary/"
# load the boundaries -----------------------------------------------------
adm2 <- rgdal::readOGR(paste0(adm.dir, "adm2.shp"))

# raster path
idir <- "/project/public/temp_yx/"
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
wgs84 <- CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
files_W <- dir(path = paste0(idir, "2000LC/rmNA"), pattern = glob2rx('*WUI*.tif'))
files_O <- dir(path = paste0(idir, "2000LC/origin"), pattern = glob2rx('*.tif'))

# west America extent(-123,-122.5,38,38.5)
i <- 45
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -123 38 -122.5 38.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -123 38 -122.5 38.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -123 38 -122.5 38.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)
# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -123 38 -122.5 38.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
c[c==0] <- NA
c[c==-10] <- 10
c[c==1|c==-9] <- 1
c[c==2|c==-8|c==3|c==-7] <- 2
c[c==4|c==-6|c==6|c==-4|c==5|c==-5|c==7|c==-3] <- 3
df_c <- as.data.frame(c, xy = T)
names(df_c) <- c("x", "y", "LC")


LCcodes <- c(1, 2, 3, 10)
LCnames <-c("2000", "2010", "2020", "Wildland")

LCcolors <- c("#04c7f3", "#fabf53", "#c20000", "#cae2bc")
names(LCcolors) <- as.character(LCcodes)
a <- crop(adm2, extent(-123,-122.5,38,38.5)) %>%
  sf::st_as_sf()
p1 <- ggplot() +
  geom_raster(data = df_c, aes(x = x, y = y, fill = as.character(LC))) +
  geom_sf(data = a, fill = "transparent") +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE) +
  theme_bw() +
   theme(
         plot.background = element_rect(color = "#add8e7", fill ="#add8e7"),
        plot.margin = margin(5,0,0,0),
        legend.background = element_rect(color = "#add8e7", fill ="#add8e7")) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = -123, xmax = -122.5, ymin = 38, ymax = 38.5), color = "black", inherit.aes = FALSE, fill = "transparent") 
l1 <- get_legend(p1) 
l1 <- plot_grid(l1) +
  theme(
         plot.background = element_rect(color = "#add8e7", fill ="#add8e7"),
        panel.background = element_rect(color = "#add8e7", fill ="#add8e7"))
p1 <- p1 + guides(fill = "none")
odir <- "~/wildfire/WUI/data/02_analysis/test"
ggsave(plot = l1,
       filename = "fig3_local_legend.pdf",
       device = "pdf", path = odir,
       width = 6, height = 7, units = "in",
       dpi = 320)
ggsave(plot = p1,
       filename = "fig3_local_CA.pdf",
       device = "pdf", path = odir,
       width = 4, height = 4, units = "in",
       dpi = 320)

# Pearl river delta extent(113.5,114,22.5,23)
i <- 484
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 113.5 22.5 114 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 113.5 22.5 114 23 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 113.5 22.5 114 23 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 113.5 22.5 114 23 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
c[c==0] <- NA
c[c==-10] <- 10
c[c==1|c==-9] <- 1
c[c==2|c==-8|c==3|c==-7] <- 2
c[c==4|c==-6|c==6|c==-4|c==5|c==-5|c==7|c==-3] <- 3
df_c <- as.data.frame(c, xy = T)
names(df_c) <- c("x", "y", "LC")


LCcodes <- c(1, 2, 3, 10)
LCnames <-c("2000", "2010", "2020", "Wildland")

LCcolors <- c("#04c7f3", "#fabf53", "#c20000", "#cae2bc")
names(LCcolors) <- as.character(LCcodes)
a <- crop(adm2, extent(113.5,114,22.5,23)) %>%
  sf::st_as_sf()
p2 <- ggplot() +
  geom_raster(data = df_c, aes(x = x, y = y, fill = as.character(LC))) +
  geom_sf(data = a, fill = "transparent") +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE) +
  theme_bw() +
   theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(5,15,0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = 113.5, xmax = 114, ymin = 22.5, ymax = 23), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")
odir <- "~/wildfire/WUI/data/02_analysis/test"
ggsave(plot = p2,
       filename = "fig3_local_CN.pdf",
       device = "pdf", path = odir,
       width = 4, height = 4, units = "in",
       dpi = 320)

# East Brazil extent(-46,-45.5,-21.5,-21)
i <- 686
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -46 -21.5 -45.5 -21 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -46 -21.5 -45.5 -21 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -46 -21.5 -45.5 -21 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te -46 -21.5 -45.5 -21 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
c[c==0] <- NA
c[c==-10] <- 10
c[c==1|c==-9] <- 1
c[c==2|c==-8|c==3|c==-7] <- 2
c[c==4|c==-6|c==6|c==-4|c==5|c==-5|c==7|c==-3] <- 3
df_c <- as.data.frame(c, xy = T)
names(df_c) <- c("x", "y", "LC")


LCcodes <- c(1, 2, 3, 10)
LCnames <-c("2000", "2010", "2020", "Wildland")

LCcolors <- c("#04c7f3", "#fabf53", "#c20000", "#cae2bc")
names(LCcolors) <- as.character(LCcodes)
a <- crop(adm2, extent(-46,-45.5,-21.5,-21)) %>%
  sf::st_as_sf()
p3 <- ggplot() +
  geom_raster(data = df_c, aes(x = x, y = y, fill = as.character(LC))) +
  geom_sf(data = a, fill = "transparent") +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE) +
  theme_bw() +
   theme(
        plot.background = element_rect(color = "#add8e7", fill ="#add8e7"),
        plot.margin = margin(5,15,0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0))  +
  labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = -46, xmax = -45.5, ymin = -21.5, ymax = -21), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")
odir <- "~/wildfire/WUI/data/02_analysis/test"
ggsave(plot = p3,
       filename = "fig3_local_BR.pdf",
       device = "pdf", path = odir,
       width = 4, height = 4, units = "in",
       dpi = 320)

# Southeasr Australia extent(146,146.5,-36,-35.5)
i <- 815
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 146 -36 146.5 -35.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 146 -36 146.5 -35.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 146 -36 146.5 -35.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 146 -36 146.5 -35.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
c[c==0] <- NA
c[c==-10] <- 10
c[c==1|c==-9] <- 1
c[c==2|c==-8|c==3|c==-7] <- 2
c[c==4|c==-6|c==6|c==-4|c==5|c==-5|c==7|c==-3] <- 3
df_c <- as.data.frame(c, xy = T)
names(df_c) <- c("x", "y", "LC")


LCcodes <- c(1, 2, 3, 10)
LCnames <-c("2000", "2010", "2020", "Wildland")

LCcolors <- c("#04c7f3", "#fabf53", "#c20000", "#cae2bc")
names(LCcolors) <- as.character(LCcodes)
a <- crop(adm2, extent(146,146.5,-36,-35.5)) %>%
  sf::st_as_sf()
p4 <- ggplot() +
  geom_raster(data = df_c, aes(x = x, y = y, fill = as.character(LC))) +
  geom_sf(data = a, fill = "transparent") +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE) +
  theme_bw() +
   theme(
        plot.background = element_rect(color = "#add8e7", fill ="#add8e7"),
        plot.margin = margin(5,15,0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0))  +
  labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = 146, xmax = 146.5, ymin = -36, ymax = -35.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")
odir <- "~/wildfire/WUI/data/02_analysis/test"
ggsave(plot = p4,
       filename = "fig3_local_AU.pdf",
       device = "pdf", path = odir,
       width = 4, height = 4, units = "in",
       dpi = 320)

# Mid Russia extent(86,86.5,52,52.5)
i <- 435
wd <- paste0(idir, "delta/")
twd <- paste0(wd, 'temp', i)

# crop 2000's raster
crop_O <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 86 52 86.5 52.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/origin/", files_O[i]), paste0(wd, 'temp', i, '/Origin_00.tif'))
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 86 52 86.5 52.5 -te_srs', paste0('"', wgs84, '" ', idir, "2000LC/rmNA/", files_W[i]), paste0(wd, 'temp', i, '/WUI_00.tif'))
system(crop_O)
system(crop_W)

# crop 2010's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 86 52 86.5 52.5 -te_srs', paste0('"', wgs84, '" ', idir, "2010LC/rmNA/", gsub("2000", "2010", files_W[i])), paste0(wd, 'temp', i, '/WUI_10.tif'))
system(crop_W)

# crop 2020's raster
crop_W <- paste('gdalwarp', '-t_srs', paste0('"', wgs84, '"'), '-co \"COMPRESS=LZW\" -r near -tr 0.0003 0.0003 -te 86 52 86.5 52.5 -te_srs', paste0('"', wgs84, '" ', idir, "2020LC/rmNA/", gsub("2000", "2020", files_W[i])), paste0(wd, 'temp', i, '/WUI_20.tif'))
system(crop_W)

# drawing
w <- raster(paste0(twd, "/Origin_00.tif"))
w[w < 20 | w > 40] <- 0
w[w != 0] <- 1

W_00 <- raster(paste0(twd, "/WUI_00.tif"))
W_10 <- raster(paste0(twd, "/WUI_10.tif"))
W_20 <- raster(paste0(twd, "/WUI_20.tif"))
delta <- 4*W_20 + 2*W_10 + W_00
c <- delta - 10 * w
c[c==0] <- NA
c[c==-10] <- 10
c[c==1|c==-9] <- 1
c[c==2|c==-8|c==3|c==-7] <- 2
c[c==4|c==-6|c==6|c==-4|c==5|c==-5|c==7|c==-3] <- 3
df_c <- as.data.frame(c, xy = T)
names(df_c) <- c("x", "y", "LC")


LCcodes <- c(1, 2, 3, 10)
LCnames <-c("2000", "2010", "2020", "Wildland")

LCcolors <- c("#04c7f3", "#fabf53", "#c20000", "#cae2bc")
names(LCcolors) <- as.character(LCcodes)
a <- crop(adm2, extent(86,86.5,52,52.5)) %>%
  sf::st_as_sf()
p5 <- ggplot() +
  geom_raster(data = df_c, aes(x = x, y = y, fill = as.character(LC))) +
  geom_sf(data = a, fill = "transparent") +
  scale_fill_manual(name = "",
                    values = LCcolors,
                    labels = LCnames,
                    na.translate = FALSE) +
  theme_bw() +
   theme(
        plot.background = element_rect(color = "transparent", fill ="transparent"),
        plot.margin = margin(5,15,0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x ="", y = "", fill = '') +
    geom_rect(aes(xmin = 86, xmax = 86.5, ymin = 52, ymax = 52.5), color = "black", inherit.aes = FALSE, fill = "transparent") + 
  guides(fill = "none")
odir <- "~/wildfire/WUI/data/02_analysis/test"
ggsave(plot = p5,
       filename = "fig3_local_RU2.pdf",
       device = "pdf", path = odir,
       width = 4, height = 4, units = "in",
       dpi = 320)
```


# draw static graph (2000-2010, 2010-2020)
```{r}
df <- NULL

d1 <- rList[[2]] - rList[[1]]
d1 <- aggregate(d1, fact = c(10, 10))
d1[d1 == 0] <- NA
df[[1]] <- as.data.frame(d1, xy=T) %>% 
  dplyr::mutate(type = '2000-2010') %>%
  filter(!is.na(layer))

d2 <- rList[[3]] - rList[[2]]
d2 <- aggregate(d2, fact = c(10, 10))
d2[d2 == 0] <- NA
df[[2]] <- as.data.frame(d2, xy=T) %>% 
  dplyr::mutate(type = '2010-2020') %>%
  filter(!is.na(layer))

delta <- aggregate(delta, fact = c(10, 10))
delta[delta == 0] <- NA
df[[3]] <- as.data.frame(delta, xy=T) %>% 
  dplyr::mutate(type = '2000-2020') %>%
  filter(!is.na(delta_20.00))
names(df[[3]]) <- names(df[[1]])

dfb <- dplyr::bind_rows(df)

a <- ggdensity(dfb, x = "layer", xlab = F, ylab = F, rug = F, 
          color = "type", fill = "type", adjust = 3, alpha = 0.3, size = 0.1,
          palette = c("#00AFBB", "#FC4E07", "#E7B800")) +
    scale_x_continuous(limits = c(-0.02, 0.02), labels = percent, expand = c(0,0)) + 
    scale_y_continuous() + 
    coord_fixed(ratio = 0.00004) +
    theme(
        legend.title = element_blank(), 
        legend.position = "none", 
        legend.text = element_text(size = 6), 
        legend.key.size = unit(0.2, 'in'),
        legend.direction = "vertical",
        axis.line.y = element_blank(), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(),
        axis.line.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank()) + 
    labs(x = "", y = "")

b <- ggplot(dfb) +
    geom_boxplot(aes(x = layer, y = factor(type, levels = c('2000-2010', '2010-2020', '2000-2020')), lwd = 0.1,
                     color = factor(type, levels = c('2000-2010', '2010-2020', '2000-2020'))),lwd = 0.1, outlier.size = 0.001) +
    scale_x_continuous(limits = c(-0.02, 0.02), breaks = c(-0.01, 0, 0.01), labels = c('-1%', '0', '1%'), expand = c(0,0)) +
    scale_y_discrete(position = "right") +
    scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07"), labels = c('2000-2010', '2010-2020', '2000-2020')) +
    theme_classic() +
    theme(aspect.ratio = 0.7,
          legend.title = element_blank(),
          legend.position = 'none', 
          legend.text = element_text(size = 6), 
          axis.text = element_text(size = 6), 
          axis.title = element_text(size = 6),
          axis.line.y = element_blank(), 
          axis.title.y = element_blank(), 
          axis.ticks.y = element_blank()) + 
    labs(x = expression(Delta(WUI) ~ "(%)"), y = '') 
  
p <- a + b + plot_layout(ncol = 1)

odir <- "~/wildfire/WUI/data/02_analysis/0401/"

ggsave(plot = p,
       filename = "fig3_density.pdf",
       device = "pdf", path = odir,
       width = 40, height = 50, units = "mm",
       dpi = 320)
```

# draw static graph (2000-2020, discard)
```{r}
odir <- "~/wildfire/WUI/data/01_GlobeLand30/delta/"
delta <- raster(paste0(odir, "delta_20-00.tif"))
delta <- aggregate(delta, fact = c(50, 50))
delta[delta == 0] <- NA
df <- as.data.frame(delta, xy = T) %>%
  filter(!is.na(delta_20.00))

p <- ggplot(data = df,aes(x = delta_20.00)) +
  geom_density(fill="#69b3a2", color="black", alpha=0.8) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(limits = c(-0.05, 0.05)) +
  theme_classic() +
  theme(
    aspect.ratio = 0.4,
    plot.margin= grid::unit(c(0.1, 0.5, 0, 0.1), "in"), 
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13),
    plot.background = element_rect(color = "transparent", fill = "transparent"),
    panel.background = element_rect(color = "transparent", fill = "transparent"),
  ) +
  labs(x = "WUI change percentage for each pixel", y = "density") 

odir <- "~/wildfire/WUI/data/02_analysis/1007/"
ggsave(plot = p,
       filename = "fig3_density.pdf",
       device = "pdf", path = odir,
       width = 5, height = 4, units = "in",
       dpi = 320)
```
